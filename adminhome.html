
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Home</title>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="dist/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Courgette&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            height: 100vh; 
            overflow: hidden; 
        }
        .sidebar {
            width: 250px; 
            height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0; 
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-right: 1px solid #ddd;
            padding-top: 20px; 
        }
        .main-content {
            margin-left: 250px; /* Space for sidebar */
            flex-grow: 1; 
            overflow-y: auto; 
        }
        nav.navbar {
            z-index: 1000; 
        }
        .sidebar .nav-link {
        color: #333;
        padding: 10px;
        margin-bottom: 5px;
        border-left: 3px solid transparent;
        display: flex;
        align-items: center;
        gap: 10px; 
        transition: all 0.3s ease;
    }
    .sidebar .nav-link:hover {
        border-left: 3px solid #ffc107;
        border-right: 3px solid #ffc107;
        background-color: #c8c8c9;
        color: black;
    }
    .sidebar .nav-link.active {
        background-color: #c5c5c5; 
        border-left: 3px solid #6a11cb; 
        border-right: 3px solid #6a11cb;
        color:black;
    }
    .card {
    transition: all 0.3s ease; 
    border: none; 
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
}

.card:hover {
    background: linear-gradient(145deg, #cd28cd, #5c14a0) !important; 
    color: white !important; 
}

.card:hover .card-title,
.card:hover .card-text,
.card:hover .bi {
    color: white !important; 
}
    </style>
</head>
<body class="bg-light text-dark">
    <div class="sidebar">
        <!-- Profile Section -->
        <div class="text-center">
            <img src="assets/images/admin-profile.jpg" class="rounded-circle img-fluid" width="80" height="80">
            <h5 class="mt-2" style="color: rgb(153, 17, 168);">Amritha</h5>
            <h3 class="mt-1" style="color: rgb(90, 11, 99);">Master Admin</h3>
        </div>
        <hr>
    
        <!-- Sidebar Menu -->
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a id="dashboardLink" href="#" class="nav-link active">
                    <i class="bi bi-grid-fill text-me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="usrmng.html" class="nav-link">
                    <i class="bi bi-person-fill me-2"></i> User Management
                </a>
            </li>
            <li class="nav-item"> 
                <a href="adminplan.html" class="nav-link">
                    <i class="bi bi-gem me-2"></i> Plan Management
                </a>
            </li>
            <li class="nav-item">
                <a href="staticpage.html" class="nav-link">
                    <i class="bi bi-table me-2"></i> Performance Overview
                </a>
            </li>
        </ul>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg sticky-top bg-black">
            <a class="navbar-brand fw-bold text-light fs-4 ms-3" href="adminhome.html">ṃȏɞı-ċȏṃṃ</a>
            <div class="ml-auto ms-auto me-4">
                <img src="assets/images/admin-profile.jpg" class="rounded-circle" width="40" height="40">
            </div>
        </nav>
        <!-- Dashboard Title Container -->
        <div class="container-fluid-expland-lg">
            <div class="text-white p-3 mb-4" style="background-color: #41075e;">
                <h3 class="text-light">Dashboard</h3>
            </div>
        </div>
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <div class="row">
                <!-- Total Users Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-people-fill display-4 text-warning"></i>
                            <h4 class="card-title fw-bold mt-2">2500</h4>
                            <p class="card-text">Total Users</p>
                        </div>
                    </div>
                </div>

                <!-- Total Plans Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-lightning-charge-fill text-warning display-4"></i>
                            <h4 class="card-title fw-bold mt-2">200</h4>
                            <p class="card-text">Total Plans</p>
                        </div>
                    </div>
                </div>

                <!-- Total Recharge Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-check-circle-fill text-warning display-4"></i>
                            <h4 class="card-title fw-bold mt-2">200</h4>
                            <p class="card-text">Total Recharge</p>
                        </div>
                    </div>
                </div>

                <!-- Total Enquiries Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-question-circle-fill text-warning display-4"></i>
                            <h4 class="card-title fw-bold mt-2">500+</h4>
                            <p class="card-text">Total Enquiries</p>
                        </div>
                    </div>
                </div>

                <!-- Total Revenue Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-currency-exchange text-warning display-4"></i>
                            <h4 class="card-title fw-bold mt-2">$50,000</h4>
                            <p class="card-text">Total Revenue</p>
                        </div>
                    </div>
                </div>

                <!-- Active Subscriptions Card -->
                <div class="col-md-4 mb-4">
                    <div class="card text-center text-dark" style="background-color: #e9ecef;">
                        <div class="card-body">
                            <i class="bi bi-shield-lock text-warning display-4"></i>
                            <h4 class="card-title fw-bold mt-2">1,800</h4>
                            <p class="card-text">Active Subscriptions</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="container-fluid p-4">
            <h4 class="text-dark ms-4 pb-3">Users With Expiring Plans</h4>
            <div class="table-responsive rounded-4">
                <table class="table table-striped table-light">
                    <thead style="background-color: #5c14a0;">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Expiry Date</th>
                            <th>View Recharge</th>
                        </tr>
                    </thead>
                    <tbody id="subscriberTable"></tbody>
                </table>
            </div>
        </div>
    </div>   
      <!-- Recharge History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-light text-white">
            <div class="modal-header">
                <h5 class="modal-title text-primary fw-bold" id="historyModalLabel">Recharge History</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-light">
                    <thead>
                        <tr>
                            <th>Plan Name</th>
                            <th>Date</th>
                            <th>Payment Mode</th>
                            <th>Validity</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>   
            document.addEventListener('DOMContentLoaded', function() {
            const accessToken = localStorage.getItem('accessToken');
            
            // If no token exists, redirect to login
            if (!accessToken) {
                window.location.href = '/admin-login.html';
                return;
            }
            
            // Verify token by making a simple request to a protected endpoint
            fetch('http://localhost:8080/auth/validate-token', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                // Token is valid, proceed with loading the page
            })
            .catch(error => {
                console.error('Authentication error:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/admin-login.html';
            });
            
            // Rest of your existing script for the page functionality
            // (fetchUsersWithExpiringPlans, etc.)
        });

// Function to fetch recharge history for a user
async function fetchRechargeHistory(userId) {
    try {
        const response = await fetch(`http://localhost:8080/api/recharge/history/${userId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch recharge history');
        }
        const rechargeHistory = await response.json();
        return rechargeHistory;
    } catch (error) {
        console.error('Error fetching recharge history:', error);
        return [];
    }
}

// Function to populate the recharge history modal
async function populateHistoryModal(userId) {
    const historyTableBody = document.getElementById('historyTableBody');
    historyTableBody.innerHTML = ''; 

    const rechargeHistory = await fetchRechargeHistory(userId);

    if (rechargeHistory.length === 0) {
        historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center">No recharge history found</td></tr>`;
        return;
    }

    rechargeHistory.forEach(recharge => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>${recharge.rechargeId}</td> <!-- Recharge ID -->
        <td>${new Date(recharge.rechargeTime).toLocaleDateString()}</td> <!-- Recharge Date -->
       <td>${recharge.payment ? recharge.payment.paymentId : 'N/A'}</td>
        <td>${recharge.status}</td> <!-- Status -->
    `;
        historyTableBody.appendChild(row);
    });
}

async function fetchUsersWithExpiringPlans() {
            try {
                const response = await fetch('http://localhost:8080/user/expiring-plans');
                const users = await response.json();
                populateSubscriberTable(users);
            } catch (error) {
                console.error('Error fetching users with expiring plans:', error);
            }
        }

        function populateSubscriberTable(users) {
            
            const tableBody = document.getElementById('subscriberTable');
            tableBody.innerHTML = ''; 

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.userid}</td>
                    <td>${user.name}</td>
                    <td>${user.mobileNumber}</td>
                    <td>${new Date(user.lastRechargeTime).toLocaleDateString()}</td>
                    <td><button class="btn btn-primary view-history" data-id="${user.userid}">View</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Event listener for view history buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-history')) {
                const userId = e.target.getAttribute('data-id');
                populateHistoryModal(userId);
                $('#historyModal').modal('show'); 
            }
        });

        // Initialize the subscriber table on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchUsersWithExpiringPlans();
        });

        // Initialize the subscriber table on page load
        window.onload = populateSubscriberTable;

    </script>    
</body>
</html>
